<!DOCTYPE html>
<html lang="ja">
<head>
	<title>参加型プレゼンツール</title>
	<meta charset="utf-8">
	<script src="/lib/jquery-1.11.1.min.js"></script>
	<script src="/lib/jquery-ui.min.js"></script>
	<script src="/lib/jMenu.jquery.min.js"></script>
	<script src="/lib/d3.js"></script>
	<script src="/js/nextPage.js"></script>
	<script src="/js/prependPage.js"></script>
	<script src="/js/keyController.js"></script>
	<script src="/js/removeForm.js"></script>
	<script src="/js/setForm.js"></script>
	<script src="/js/slideLoad.js"></script>
	<script src="/js/slideReload.js"></script>
	<script src="/js/createQuestion.js"></script>
	<script src="/js/createComment.js"></script>
	<script src="/js/startUp.js"></script>
	<script src="/js/save.js"></script>
	<script src="/js/reload.js"></script>
	<script src="/js/count.js"></script>
	<script src="/socket.io/socket.io.js"></script>

	<link rel="stylesheet" type="text/css" href="/css/slide.css">
	<link rel="stylesheet" type="text/css" href="/css/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="/css/jmenu.css">
	<style>
	body{
		font: 62.5% "Trebuchet MS", sans-serif;
		/*margin: 50px;*/
	}
	#icons {
		margin: 0;
		padding: 0;
	}
	#icons li {
		margin: 2px;
		position: relative;
		padding: 4px 0;
		cursor: pointer;
		float: left;
		list-style: none;
	}
	#icons span.ui-icon {
		float: left;
		margin: 0 4px;
	}
	.fakewindowcontain .ui-widget-overlay {
		position: absolute;
	}
	select {
		width: 200px;
	}

	#questions {
		font: 150% "Trebuchet MS", sans-serif;
		letter-spacing: 2em;
	}
	#comments {
		font: 150% "Trebuchet MS", sans-serif;
	}
	#questionDialog {
		font: 150% "Trebuchet MS", sans-serif;
	}
	</style>
</head>
<body onload="startUp()">
	<div id="main">
		<div id="menu">
			<!-- メニュー（jMenuを採用） -->
			<ul id="jMenu">
				<li class="test">
					<a href="" id="addSlide">スライド追加</a>
				</li>
				<li class="test">
					<a href="" id="addTool">機能追加</a>
					<ul>
						<li><a href="" id="questionForm">アンケート</a></li>
						<li><a href="" id="commentForm">感想</a></li>
					</ul>
				</li>
				<li>
					<a href="" id="register">登録</a>
				</li>
				<li>
					<a href="" id="save">現在の状態を保存</a>
				</li>
				<li>
					<a href="" id="count">集計</a>
				</li>
			</ul>
		</div>
		<div id="main-contents">
			<!-- スライド -->
			<figure id="slide"></figure>
			<div id="chatArea">
				<ul id="logs"></ul>
			</div>
			<form id="chatForm">
				<input type="text" id="msg"> <input type="submit" value="Send">
			</form>
		</div>
	</div>
	<div id="canvas" title="アンケートの集計結果"></div>

	<!-- アンケート機能追加時のダイアログ -->
	<div id="questionDialog" title="アンケート機能の追加">
		<input id="spinner" value="1">
		<p>選択肢の数を入力して下さい。</p>
	</div>
	<!-- アンケート -->
	<form>
		<div id="questions"></div>
	</form>

	<!-- 感想 -->
	<form>
		<div id="comments"></div>
	</form>
	<!-- スクリプト -->
	<script>
	var socket = io.connect();

	socket.on('reload_from_server',function(jsondata){
		reload(jsondata);
	});

	// emit: イベントを発信している
	// on: イベントを待ち受けている
	$('#chatForm').submit(function(e){
		e.preventDefault();
		socket.emit('emit_from_client',$('#msg').val());
		// 複数の値を送る時、jsonで渡す
		//socket.json.emit('emit_from_client',{
		//	msg: $('#msg').val(),
		//	name: $('#name').val()
		//});
		$('#msg').val('').focus();
	});
	socket.on('emit_from_server',function(data){
		$('#logs').append($('<li>').text(data));
	});

	$(document).ready(function() {
		$('#jMenu').jMenu({
			openClick : false,
			ulWidth :'150',
			TimeBeforeOpening : 100,
			TimeBeforeClosing : 11,
			animatedText : false,
			paddingLeft: 1,
			effects : {
				effectSpeedOpen : 150,
				effectSpeedClose : 150,
				effectTypeOpen : 'slide',
				effectTypeClose : 'slide',
				effectOpen : 'swing',
				effectClose : 'swing'
			}
		});
	});

	$( '#spinner' ).spinner({
		max:9,
		min:1
	});

	// ダイアログ
	$( '#questionDialog' ).dialog({
		autoOpen: false,
		width: 300,
		modal: true,
		buttons: [
		{
			text: "Ok",
			click: function() {
				createQuestion($('#spinner').spinner("value"),0,50,false);
				$( this ).dialog( "close" );
			}
		},
		{
			text: "Cancel",
			click: function() {
				$( this ).dialog( "close" );
			}
		}
		]
	});

	// サーバにスライド読み込みのメッセージを送信
	$('#addSlide').click(function(evt){
		socket.emit('slideload_from_client');
		evt.preventDefault();
	});
	// スライドに使う画像を#slideに追加
	// length:スライドに使う画像のファイル数
	socket.on('slideload_from_server',function(length){
		slideLoad(length);
	});

	// evt.preventDefaultしておかないと機能追加ボタンがaタグなのでクリックするとページが更新されてしまう
	$('#addTool').click(function(evt){evt.preventDefault();});

	// 機能追加のメニューでアンケートボタンを押した時、ダイアログを表示する
	$('#questionForm').click(function(evt){
		$('#questionDialog').dialog("open");
		evt.preventDefault();
	});

	$('#commentForm').click(function(evt){
		createComment(0,50,false);
		evt.preventDefault();
	});


	// 集計ボタン
	$('#count').click(function(evt){
		socket.emit('countDialog_from_client');
		//$('#canvas').dialog("open");
		//socket.emit('count_from_client');
		evt.preventDefault();
	});
	socket.on('countDialog_from_server',function(){
		$('#canvas').dialog("open");
	});
	$( '#canvas' ).dialog({
		id:'canvasDialog',
		autoOpen: false,
		width: 500,
		modal: true,
		buttons: [
		{
			text: "集計",
			click: function() {
				socket.emit('count_from_client');
			}
		}
		]
	});

	$('#save').click(function(evt){
		save();
		evt.preventDefault();
	})

	// question.txtファイルからアンケートの集計を行う
	// answerList:question.txtの中身をカンマで区切ったリスト
	socket.on('count_from_server',function(answerList){
		count(answerList);
		//socket.emit('rmQuestionFile_from_client');
	});

	// 最後の要素を#slideの先頭に追加（移動）させる
	socket.on('nextpage_from_server',function(){
		nextPage();
	});
	// 最初の要素を#slideの末尾に追加（移動）させる
	socket.on('prepage_from_server',function(){
		prependPage();
	});


	$('#register').click(function(evt){
		socket.emit('register_from_client');
		//SWSetCookie('sw_javascriptauth_password', 'aiueo');
		evt.preventDefault();
	});

	socket.on('register_from_server',function(id){
		SWSetCookie('sw_javascriptauth_password', id);
	});

	function SWSetCookie(name, value, expire, path)
	{
		var cookie = name + '=' + escape(value);
		if(expire)
		{
			cookie += '; expires=' + expire.toGMTString();
		}
		if(path)
		{
			cookie += '; path=' + path;
		}
		document.cookie = cookie;
	}

	</script>
</body>
</html>